---
title: CVE-2021-3156
author: nepire
avatar: /images/title.ico
authorLink: 'https://nepire.github.io/'
authorAbout: 逐梦者
authorDesc: 逐梦者
categories: 技术
comments: true
date: 2021-02-04 20:20:21
tags:
keywords:
description:
photos:
---
# CVE-2021-3156

## 简介
sudo中堆溢出导致的权限提升

通过文件名溢出控制加载的libc，并制作setuid为0起root_shell的一个库

关键漏洞函数为set_cmnd，源码路径为"plugins/sudoers/sudoers.c"

关键利用函数为nss_load_library，源码路径为"nss/nsswitch.c"

## 分析环境
```
ubuntu@1804:~/CVE-2021-3156$ uname -a
Linux 1804 4.15.0-136-generic #140-Ubuntu SMP Thu Jan 28 05:20:47 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux
ubuntu@1804:~/CVE-2021-3156$ sudo -V
Sudo version 1.8.21p2
Sudoers policy plugin version 1.8.21p2
Sudoers file grammar version 46
Sudoers I/O plugin version 1.8.21p2
```

## 漏洞函数
``` c
841		/* set user_args */
842		if (NewArgc > 1) {
843		    char *to, *from, **av;
844		    size_t size, n;
845
846		    /* Alloc and build up user_args. */
847		    for (size = 0, av = NewArgv + 1; *av; av++)
848			size += strlen(*av) + 1;
849		    if (size == 0 || (user_args = malloc(size)) == NULL) {
850			sudo_warnx(U_("%s: %s"), __func__, U_("unable to allocate memory"));
851			debug_return_int(-1);
852		    }
853		    if (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) {
854			/*
855			 * When running a command via a shell, the sudo front-end
856			 * escapes potential meta chars.  We unescape non-spaces
857			 * for sudoers matching and logging purposes.
858			 */
859			for (to = user_args, av = NewArgv + 1; (from = *av); av++) {
860			    while (*from) {
861				if (from[0] == '\\' && !isspace((unsigned char)from[1]))
862				    from++;
863				*to++ = *from++;
864			    }
865			    *to++ = ' ';
866			}
867			*--to = '\0';
868		    }
```
